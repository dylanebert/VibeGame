# VibeGame Engine

3D game engine with declarative XML and ECS. Auto-creates player, camera, lighting - just add ground.

## Quick Start

```html
<script src="https://cdn.jsdelivr.net/npm/vibegame@latest/dist/cdn/vibegame.standalone.iife.js"></script>
<world canvas="#game-canvas" sky="#87ceeb">
  <static-part pos="0 -0.5 0" shape="box" size="20 1 20" color="#90ee90"></static-part>
</world>
<canvas id="game-canvas"></canvas>
<script>GAME.run();</script>
```

Auto-created: Player (WASD+jump), orbital camera (mouse), lighting with shadows.

## Critical Rules

⚠️ **Physics overrides transform**: Use `pos` on physics entities, not transform position.
⚠️ **Ground required**: Player falls forever without `<static-part>` ground.
⚠️ **Bare attributes = defaults**: `<entity transform>` includes transform with defaults.

## Core Concepts

### ECS Architecture
- **Entities**: IDs only (numbers)
- **Components**: Data (position, health)
- **Systems**: Logic processing entities with specific components
- **Queries**: Find entities by components

### Update Phases
1. **SetupBatch**: Input, frame init (once/frame)
2. **FixedBatch**: Physics at 50Hz (0-N times/frame)
3. **SimulationBatch**: Game logic
4. **DrawBatch**: Rendering, interpolation

## Physics Recipes

```xml
<!-- Static: immovable (grounds, walls) -->
<static-part pos="0 -0.5 0" shape="box" size="20 1 20" color="#808080"></static-part>

<!-- Dynamic: gravity-affected (balls, crates) -->
<dynamic-part pos="0 5 0" shape="sphere" size="1" color="#ff0000"></dynamic-part>

<!-- Kinematic: script-controlled (platforms, doors) -->
<kinematic-part name="lift" pos="0 2 0" shape="box" size="3 0.5 3"></kinematic-part>
<tween target="lift" attr="body.pos-y" from="2" to="5" duration="3" easing="sine-in-out"></tween>
```

### Position Pitfall
```xml
<!-- ❌ WRONG: transform position ignored with physics -->
<entity transform="pos: 0 5 0" body collider></entity>

<!-- ✅ CORRECT: pos shorthand applies to body -->
<dynamic-part pos="0 5 0" shape="sphere"></dynamic-part>
```

## Recipe Reference

| Recipe | Purpose | Key Attributes |
|--------|---------|---------------|
| `<static-part>` | Immovable | `pos`, `shape`, `size`, `color` |
| `<dynamic-part>` | Falls with gravity | `pos`, `shape`, `size`, `color`, `mass` |
| `<kinematic-part>` | Script-controlled | `pos`, `shape`, `size`, `color` |
| `<renderer>` | Visual only | `pos`, `shape`, `size`, `color` |
| `<player>` | Character | `pos`, `speed`, `jump-height` |
| `<tween>` | Animation | `target`, `attr`, `to`, `duration`, `easing` |
| `<sequence>` | Animation group | `name`, `autoplay` |
| `<pause>` | Sequence timing | `duration` |

**Shapes**: `box`, `sphere`
**Size**: `size="w h d"` or broadcast `size="2"` → `2 2 2`

## Tweening

One-shot animations that auto-destroy. Reference entities by `name`.

```xml
<kinematic-part name="door" pos="0 0 0" shape="box" size="2 4 0.2"></kinematic-part>
<tween target="door" attr="body.pos-y" to="3" duration="2" easing="sine-out"></tween>
```

### Shorthands
| Shorthand | Expands To |
|-----------|------------|
| `at` | transform.posX/Y/Z |
| `scale` | transform.scaleX/Y/Z |
| `rotation` | body.eulerX/Y/Z (or transform) |

### Easing
`linear`, `sine-in/out/in-out`, `quad-*`, `cubic-*`, `back-*`, `elastic-*`, `bounce-*`

## Sequences

Orchestrate tweens with timing. Tweens before `<pause>` run in parallel.

```xml
<sequence name="bounce">
  <tween target="cube" attr="scale" to="1.3 1.3 1.3" duration="0.15" easing="back-out"></tween>
  <pause duration="0.1"></pause>
  <tween target="cube" attr="scale" to="1 1 1" duration="0.15"></tween>
</sequence>
```

```typescript
import { playSequence, resetSequence } from 'vibegame/tweening';
const seq = state.getEntityByName('bounce');
resetSequence(state, seq);
playSequence(state, seq);
```

## Optional Plugins

### Post-Processing
```typescript
import { PostprocessingPlugin } from 'vibegame/postprocessing';
GAME.withPlugin(PostprocessingPlugin).run();
```
```xml
<orbit-camera bloom="intensity: 2" tonemapping="mode: aces-filmic"></orbit-camera>
```

### 3D Text
```typescript
import { TextPlugin } from 'vibegame/text';
GAME.withPlugin(TextPlugin).run();
```
```xml
<word text="Hello" font-size="2" color="#ff0000"></word>
<paragraph gap="0.3"><word text="Hello"></word><word text="World"></word></paragraph>
```

### Vector Lines
```typescript
import { LinePlugin } from 'vibegame/line';
GAME.withPlugin(LinePlugin).run();
```
```xml
<entity transform line="offset: 3 2 0; color: 0xff0000; arrow-end: 1"></entity>
```

## Custom Plugin Pattern

```typescript
const Health = GAME.defineComponent({ current: GAME.Types.f32, max: GAME.Types.f32 });
const healthQuery = GAME.defineQuery([Health]);

const HealthSystem: GAME.System = {
  group: 'simulation',
  update: (state) => {
    for (const entity of healthQuery(state.world)) {
      if (Health.current[entity] < Health.max[entity])
        Health.current[entity] += 5 * state.time.deltaTime;
    }
  }
};

const HealthPlugin: GAME.Plugin = {
  components: { Health },
  systems: [HealthSystem],
  config: { defaults: { health: { current: 100, max: 100 } } }
};

GAME.withPlugin(HealthPlugin).run();
```

## State API

```typescript
// Entity management
state.createEntity(): number
state.destroyEntity(entity)
state.getEntityByName(name): number | null

// Components
state.addComponent(entity, Component, data?)
state.removeComponent(entity, Component)
state.hasComponent(entity, Component): boolean

// Time
state.time.delta    // Frame time (seconds)
state.time.elapsed  // Total time
state.time.fixed    // Fixed timestep (1/50)
```

## Headless CLI

For testing without browser/WebGL:

```typescript
import { createHeadlessState, parseWorldXml, getEntityNames, toJSON, createProjector } from 'vibegame/cli';

const state = createHeadlessState({ plugins: DefaultPlugins });
await state.initializePlugins();
parseWorldXml(state, xmlContent);

state.step(1/60);
const project = createProjector(state);
console.log(toJSON(state.snapshot({ entities: getEntityNames(state), project })));
```

Screen projection returns `{ x, y, z, visible }` for each entity (1920x1080 default viewport).

## Common Mistakes

```xml
<!-- ❌ No ground → player falls forever -->
<world canvas="#game-canvas">
  <dynamic-part pos="0 5 0" shape="sphere"></dynamic-part>
</world>

<!-- ❌ Dynamic platform falls with gravity -->
<dynamic-part name="platform" pos="0 3 0"></dynamic-part>
<tween target="platform" attr="body.pos-x" from="-5" to="5"></tween>

<!-- ✅ Use kinematic for controlled movement -->
<kinematic-part name="platform" pos="0 3 0"></kinematic-part>
```

## Plugin Reference

{{EMBEDDED_REFERENCES}}
